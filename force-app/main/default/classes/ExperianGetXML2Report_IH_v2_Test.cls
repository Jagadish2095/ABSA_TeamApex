/*
* Test Integration Handler for ExperianGetXML2Report Service version 2
* @author Danie Booysen
* @created 2020-10-01
*/

@isTest
public class ExperianGetXML2Report_IH_v2_Test {

    public static final String POSITIVE_RESPONSE_BODY = '{"GetXML2ReportResult":[{"Session":{"User_ID":"TESTMAHL","FullName":"TESTMAHL","GroupName":"047353","Subscriber_ID":"047353","Group_ID":"047353","RequestType":"XML2","Environment":"TEST","Version":"1.0.0"},"InputData":{"First_Name_1":"DESERY","Surname":"GOVENDER","National_ID":"8109100231084","RSA_ID":"YES","Birthday":"19810910"},"SubscriberInfo":{"BusinessType":"0"},"ReturnData":{"Match":"1","Name":"DESERY  GOVENDER","Title":"MRS","Surname":"GOVENDER","FirstName1":"DESERY","ID":"8109100231084","Birthday":"19810910","Address":{"Relation":"Primary Address","ReportDate":"20200824","Address_Line1":"POSTNET SUITE RG    PRIVA","Address_Line2":null,"ZipCode":null},"ReferenceNo":"0452519812","Date":"2020-10-01","Time":"10:31","ExecTime":"7.2","SessionID":"THK9QJOCKHR"},"Detect":{"Flag":"Inactive","IDverification":{"IDverified":"Yes","SurnameVerified":"Yes","InitialsVerified":"Yes","ExperianIDnumber":"8109100231084","ExperianSurname":"GOVENDER","ExperianInitials":"DESERY"},"DisputeIndicator":"N"},"ScoreBlock":{"Delphi":[{"Score":"5","Scorecard_Identifier":"035","ReasonCode":"35073505350935083510","ScoreName":"Risk Rating","RequestID":"6"}]},"Enquiry":{"CPA":{"Own":[{"EnquiryDate":"20200929","SubscriberName":"ABSA RELATIONSHIP","Subscriber_Operator":"TESTMAHL"},{"EnquiryDate":"20200929","SubscriberName":"ABSA RELATIONSHIP","Subscriber_Operator":"TESTMAHL"},{"EnquiryDate":"20200929","SubscriberName":"ABSA RELATIONSHIP","Subscriber_Operator":"TESTMAHL"},{"EnquiryDate":"20200827","SubscriberName":"ABSA RELATIONSHIP","Subscriber_Operator":"TESTMAHL"}],"Other":[{"EnquiryDate":"20200910","SubscriberName":"MERCHTST","Subscriber_Operator":"MERCHTST"}]}},"Judgements":{"Judgement":[{"CourtName":"RANDBURG","CourtID":"204","CaseNumber":"142932018","JudgementDate":"20180906","JudgementAmount":"19120","TypeOfCourt":"2","Plaintiff":"THE INDEPENDENT INSTITUTE OF","Reason":"ARR","PublicDataCatCode":"100","PublicDataCatCodeDesc":"Judgement"},{"CourtName":"RANDBURG","CourtID":"204","CaseNumber":"61102018","JudgementDate":"20180716","JudgementAmount":"28650","TypeOfCourt":"2","Plaintiff":"THE INDEPENDENT INSTITUTE OF","Reason":"ARR","PublicDataCatCode":"100","PublicDataCatCodeDesc":"Judgement"}]},"Defaults":{"Addresses":{"Address":[{"Relation":"Primary Address","ReportDate":"20200824","Address_Line1":"POSTNET SUITE RG    PRIVA","Address_Line2":null,"CityArea":null,"ZipCode":null},{"Relation":"Primary Address","ReportDate":"20200819","Address_Line1":"POSTNET SUITE    PARKVIEW","Address_Line2":null,"CityArea":"JOHANNESBURG","ZipCode":"2000"},{"Relation":"Primary Address","ReportDate":"20200724","Address_Line1":"SUITE 41 PRIVATE BAG X","Address_Line2":"SANDTON","CityArea":"ZA","ZipCode":"0000"}]},"Telephones":{"Telephone":[{"PhonePrefix":"11","PhoneNumber":"7836571","LastReportedDate":"20200817","PhoneType":"Home"},{"PhonePrefix":"11","PhoneNumber":"6150504","LastReportedDate":"20200812","PhoneType":"Work"},{"PhonePrefix":"76","PhoneNumber":"3601226","LastReportedDate":"20200731","PhoneType":"Cell"}]},"Employers":{"Employer":[{"Name":"YAHTMASTER","Occupation":"MANAGER             00","Employer_Address":"MANAGER","Date_Supplied":"00000000","Income_Frequency":"M"},{"Name":"ENOLOGY TRADE AND IN","Occupation":"PROFESSIONAL        00","Employer_Address":"PROFESSIONAL","Date_Supplied":"00000000","Income_Frequency":"M"}]},"Summary":{"Judgements":{"Total_Number_of_Judgments_Ever":"2","Number_of_Judgments_in_the_Last_30_days":"0","Number_of_Judgments_in_the_Last_90_days":"0","Number_of_Judgments_in_the_Last_180_days":"0","Number_of_Judgments_in_the_Last_year":"0","Number_of_Judgments_in_the_Last_2_years":"0","Number_of_Judgments_in_the_Last_3_years":"2","Number_of_Judgments_in_the_Last_4_years":"2","Number_of_Judgments_in_the_Last_5_years":"2","Total_Judgment_Value":"47770","Highest_Judgment_Value":"28650","Value_of_Most_Recent_Judgment":"19120","Total_Number_of_Medical_Judgments":"0","Total_Value_of_Medical_Judgments":"0","Total_Number_of_Other_Judgments":"2","Total_Value_of_Other_Judgments":"47770","Number_of_Judgments_in_the_Previous_6_Months":"0","Number_of_Judgments_in_the_Last_7_to_18_Months":"0","Number_of_Judgments_in_the_Last_19_to_36_Months":"2","Number_of_Judgments_Older_than_37_Months":"0"},"Adverses":{"CPA":{"Total_Number_of_Adverses_Ever":"0","Number_of_CPA_adverses_ever":"0"}},"Trace":{"Total_Number_of_Traces_Ever":"0","Number_of_Traces_in_the_Last_30_days":"0","Number_of_Traces_in_the_Last_60_days":"0","Number_of_Traces_in_the_Last_90_days":"0","Number_of_Traces_in_the_Last_180_days":"0","Number_of_Traces_in_the_Last_year":"0","Number_of_Traces_in_the_Last_2_years":"0","Number_of_Traces_in_the_Last_3_years":"0","Number_of_Traces_in_the_Last_4_years":"0","Number_of_Traces_in_the_Last_5_years":"0"},"Notices":{"Total_Number_of_Notices_Ever":"0","Number_of_Notices_in_the_Last_30_days":"0","Number_of_Notices_in_the_Last_90_days":"0","Number_of_Notices_in_the_Last_180_days":"0","Number_of_Notices_in_the_Last_year":"0","Number_of_Notices_in_the_Last_2_years":"0","Number_of_Notices_in_the_Last_3_years":"0","Number_of_Notices_in_the_Last_4_years":"0","Number_of_Notices_in_the_Last_5_years":"0","Number_of_Notices_in_the_Previous_6_Months":"0","Number_of_Notices_in_the_Last_7_to_18_Months":"0","Number_of_Notices_in_the_Last_19_to_36_Months":"0","Number_of_Notices_Older_than_37_Months":"0"},"Enquiries":{"CPA":{"Own":{"Total_Number_of_Own_Enquiries_Ever":"{4}","Number_of_Own_Enquiries_in_the_Last_30_days":"{3}","Number_of_Own_Enquiries_in_the_Last_90_days":"{4}","Number_of_Own_Enquiries_in_the_Last_180_days":"{4}","Number_of_Own_Enquiries_in_the_Last_year":"{4}"},"Other":{"Total_Number_of_Other_Enquiries_Ever":"{1}","Number_of_Other_Enquiries_in_the_Last_30_days":"{1}","Number_of_Other_Enquiries_in_the_Last_90_days":"{1}","Number_of_Other_Enquiries_in_the_Last_180_days":"{1}","Number_of_Other_Enquiries_in_the_Last_year":"{1}"},"All":{"Total_Number_of_All_Enquiries_Ever":"5"}}},"Payment_Profiles":{"CPA":{"Other":{"Number_of_Other_PPs_Ever":"{18}","Number_of_Other_Revolving_PPs_Ever":"{6}","Number_of_Other_Fixed_Installment_PPs_Ever":"{2}","Total_number_of_other_Delinquent_Accounts":"{6}","Total_number_of_other_Active_accounts":"{7}","Number_of_other_accounts_opened_4to12_months_ago":"{1}","Number_of_other_accounts_opened_for_at_least_12_months":"{17}","Total_number_of__active_non_delinquent_CPA_accounts_opened_L6m":"{0}","Number_of_Other_PPs_in_the_Last_30_Days":"{0}","Number_of_Other_PPs_in_the_Last_90_Days":"{0}","Number_of_Other_PPs_in_the_Last_180_Days":"{0}","Number_of_Other_PPs_in_the_Last_Year":"{1}","Number_of_Other_PPs_in_the_Last_2_Years":"{1}","Number_of_Other_PPs_in_the_Last_3_Years":"{2}","Number_of_Other_PPs_in_the_Last_4_Years":"{2}","Number_of_Other_PPs_in_the_Last_5_Years":"{7}","Number_of_Currently_Open_Other_PPs":"{15}","Months_Since_Most_Recent_opened_Other_PP":"{7}","Months_Since_Oldest_Opened_Other_PPs":"{83}","Capital_Amount_of_Other_PPs_Opened_in_the_Last_30_Days":"{0}","Capital_Amount_of_Other_PPs_Opened_in_the_Last_90_Days":"{0}","Capital_Amount_of_Other_PPs_Opened_in_Last_180_Days":"{0}","Capital_Amount_of_Other_PPs_Opened_in_the_Last_Year":"{0}","Capital_Amount_of_Other_PPs_Opened_in_the_Last_2_Years":"{0}","Monthly_Installment_Value_of_Currently_Open_Other_PPs":"{641104}","Monthly_CPA_Installment_Other":"{3214}","Outstanding_CPA_Balance_Other":"{26477}","Total_value_of_Other_Delinquent_accounts":"{806173}","Total_outstanding_balance_on_Other_active_accounts":"{816024}","Outstanding_Balance_on_non_delinquent_revolving_CPA_opened_L6m":"{0}","Outstanding_Balance_on_delinquent_revolving_CPA_accounts":"{25262}","Number_of_Closed_Other_PPs":"{3}","Number_of_Open_Revolving_Other_PPs":"{5}","Number_of_Closed_Revolving_Other_PPs":"{1}","Number_of_Open_Fixed_Installment_Other_PPs":"{2}","Number_of_Closed_Fixed_Installment_Other_PPs":"{0}","Worst_Arrears_on_Other_PPs_ever":"{9}","Worst_Arrears_on_Closed_Other_PPs":"{9}","Worst_Arrears_on_Open_Other_PPs":"{9}","Worst_Arrears_Level_of_Most_Recent_Other_Opened_PP":"{8}","Number_of_Written_Off_Other_PPs":"{0}","Number_of_Absconded_Other_PPs":"{0}","Number_of_Habitually_Slow_Other_PPs":"{0}","Number_of_Disputed_Other_PPs":"{0}","Current_Balance_of_All_Other_PPs":"{954653}","Total_Credit_Limit_of_Revolving_Other_PPs":"{37917}","Total_Balance_of_Revolving_Other_PPs":"{47061}","Total_Installment_of_Revolving_Other_PPs":"{10558}","Total_Credit_Limit_of_Fixed_Installment_Other_PPS":"{804564}","Total_Balance_of_Fixed_Installment_Other_PPs":"{665272}","Total_Installment_of_Fixed_Installment_Other_PPs":"{405122}","Total_Credit_Limit_of_Other_Open_Account_PPs":"{0}","Total_Balance_of_Other_Open_Account_PPs":"{69310}","Total_Installment_of_Other_Open_Account_PPs":"{69310}"},"All":{"Number_of_All_PPs_Ever":"20","Number_of_Currently_Open_All_PPs":"17","Number_of_Closed_All_PPs":"3","Total_Balance_of_All_Open_Account_PPs":"69310"}},"NLR":{"All":{"Total_Monthly_One_Month_Installment_":"0"}}}}}}]}';

    @TestSetup
    static void makeData(){
        IntegrationTestDataFactory.insertIntegrationSettings(StringConstants.JITTERBIT2, new List<String>{ExperianGetXML2Report_IH_v2.INTEGRATION_SERVICE_NAME});

        Contact testContact;
        testContact = new Contact();
        testContact.FirstName = 'Test';
        testContact.LastName = 'Contact';
        testContact.Title = 'Mr.';
        testContact.Salutation = 'Mr.';
        testContact.ID_Type__c = 'SA Identity Document';
        insert testContact;
    }

    @isTest static void testPositive() {
        // Set mock callout class
        Test.setMock(HttpCalloutMock.class, new Sys_Utilities_Integration_Mock_ApiRest(StringConstants.POSITIVE_STRING, POSITIVE_RESPONSE_BODY));

        Test.startTest();

        ExperianGetXML2Report_Resp_IB_v2 responseBean = callHandlerMethod();
        System.assertEquals(200, responseBean.statusCode);

        Test.stopTest();
    }

    private static ExperianGetXML2Report_Resp_IB_v2 callHandlerMethod() {
        ExperianGetXML2Report_Req_IB_v2 dummyBean = ExperianGetXML2Report_Req_IB_v2.createDummyRequest();
        Contact testContact = [SELECT FirstName, LastName, Birthdate, ID_Number__c, ID_Type__c FROM Contact LIMIT 1];
        List<Contact> contactList = new List<Contact>();
        contactList.add(testContact);
        ExperianGetXML2Report_Resp_IB_v2 responseBean = ExperianGetXML2Report_IH_v2.ExperianGetXML2Report(contactList);
        return responseBean;
    }
}