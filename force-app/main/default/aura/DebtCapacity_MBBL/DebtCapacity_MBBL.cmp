<aura:component
  access="global"
  controller="DebtCapacity_MBBL_Controller"
  implements="lightning:availableForFlowScreens,force:appHostable,flexipage:availableForAllPageTypes,flexipage:availableForRecordHome,force:hasRecordId,forceCommunity:availableForAllPageTypes,force:lightningQuickAction"
>

    <aura:attribute name="showMBBLModal" type="Boolean" default="false"/>
    <aura:attribute name="showLoanInputModal" type="Boolean" default="false"/>
    <aura:attribute name="isDataEdit" type="Boolean" default="false"/>
    <aura:attribute name="resultsAvailable" type="Boolean" default="false"/>
    <aura:attribute name="showBodySpinner" type="Boolean" default="false"/>
    <aura:attribute name="showModalSpinner" type="Boolean" default="false"/>
    <aura:attribute name="mbblInputData" type="DebtCapacity_MBBL_Controller.MBBLDataStructure"/>
    <aura:attribute name="mbblLoanInputData" type="DebtCapacity_MBBL_Controller.LoanDetailsDTO"/>
    <aura:attribute name="mbblTableData" type="List"/>
    <aura:attribute name="mbblResultsTableData" type="List"/>
    <aura:attribute name="mbblLoansResultsTableData" type="List"/>
    <aura:attribute name="mbblEKRResultsTableData" type="List"/>
    <aura:attribute name="ttcOptions" type="List"/>
    <aura:attribute name="mbblType" type="List"/>
    <aura:attribute name="propertyRatingType" type="List"/>
    <aura:attribute name="loanTypes" type="List"/>
    <aura:attribute name="loanScenarioData" type="List"/>
    <aura:attribute name="allStoredMbblData" type="List"/>
    <aura:attribute name="dataEditIndex" type="Integer"/>
    <aura:attribute name="loanEditIndex" type="Integer"/>
    <aura:attribute name="customDate" type="String"/>
    <aura:attribute name="customLoanDate" type="String"/>

    <lightning:notificationsLibrary aura:id="notifLib" />
    
    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>

    <!-- Loader -->
    <aura:if isTrue="{!v.showBodySpinner}">
        <div class="slds-spinner_container">
            <lightning:spinner aura:id="spinner" variant="brand" size="medium" alternativeText="Loading...." />
        </div>
    </aura:if>

    <aura:if isTrue="{!v.showBodySpinner == false}">
        <!-- Loan Modal View -->
    <div style="margin: 10px;">
        <aura:if isTrue="{!v.showLoanInputModal == true}">
                <div class="slds">
                    <div aria-hidden="true" role="dialog" class="slds-modal slds-modal--prompt slds-fade-in-open slds-modal_large" aura:id="modaldialog">
                        <div class="slds-modal__container">
                            <div class="slds-modal__header">
                                <lightning:buttonIcon iconName="utility:close"    
                                                      variant="container" 
                                                      alternativeText="Close"   
                                                      class="slds-float_right" 
                                                      title="Close"
                                                      size="large"
                                                      onclick="{!c.hideModal}">
                                </lightning:buttonIcon>
                                <h2 class="slds-text-heading--medium">MBBL Loan Data</h2>
                            </div>
                            <div class="slds-modal__content slds-p-around--medium" style="padding-bottom: 90px">
                                <div class="slds-p-around_medium">
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="1" min="0" aura:id="mbblLoanInput" label="Term (Months)" value="{!v.mbblLoanInputData.term}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblLoanInput" label="Amount" value="{!v.mbblLoanInputData.loanAmount}" type="number" required="true" />
                                        </lightning:layoutItem>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:combobox
                                                aura:id="mbblLoanInput"
                                                name="loanTypes"
                                                label="Select Loan Category"
                                                value="{!v.mbblLoanInputData.loanType}"
                                                placeholder="Select Loan Category"
                                                options="{!v.loanTypes}"
                                                required="true">
                                            </lightning:combobox>
                                            <lightning:input step="0.01" min="0" max="100" aura:id="mbblLoanInput" label="Interest Rate" value="{!v.mbblLoanInputData.intrestRate}" type="number" required="true" />
                                        </lightning:layoutItem>
                                    </lightning:layout>
                                    <lightning:button label="Save"
                                                      variant="brand" 
                                                      class="slds-button slds-m-top--medium slds-float_right"
                                                      onclick="{!c.saveLoanData}"/>
                                    <div class="mbblModalMargin"></div>
                                    <aura:if isTrue="{!v.showModalSpinner}">
                                        <div class="slds-spinner_container">
                                            <lightning:spinner aura:id="spinner" variant="brand" size="medium" alternativeText="Loading...." />
                                        </div>
                                    </aura:if>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="slds-backdrop slds-backdrop--open" aura:id="backdrop">
            </div>
    </aura:if>
    <!-- Fin Modal View -->
        <aura:if isTrue="{!v.showMBBLModal == true}">
                <div class="slds">
                    <div aria-hidden="true" role="dialog" class="slds-modal slds-modal--prompt slds-fade-in-open slds-modal_large" aura:id="modaldialog">
                        <div class="slds-modal__container">
                            <div class="slds-modal__header">
                                <lightning:buttonIcon iconName="utility:close"    
                                                      variant="container" 
                                                      alternativeText="Close"   
                                                      class="slds-float_right" 
                                                      title="Close"
                                                      size="large"
                                                      onclick="{!c.hideModal}">
                                </lightning:buttonIcon>
                                <h2 class="slds-text-heading--medium">Add MBBL Financial Data</h2>
                            </div>
                            <div class="slds-modal__content slds-p-around--medium">
                                <div class="slds-p-around_medium">
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input aura:id="mbblInputs" label="Period of financial statements" value="{!v.customDate}" dateStyle="short" type="Date" displayDatePicker="true" format="yyyy/MM/dd" required="true" />
<!--                                             <ui:inputDate label="Period of financial statements" aura:id="mbblInputs" value="{!v.customDate}" displayDatePicker="true" format="yyyy/MM/dd" required="true"/>
 -->                                            <label class="slds-form-element__label"  style="margin-right: 0.5rem;">
                                                <abbr class="slds-required" title="required">*</abbr>Number of Months in Financial Statements </label>                                    
                                            <lightning:helptext content="E.g. 12 months if annual, 6 months if semi-annual, etc" class="customIcon"/>
                                            <lightning:input step="1" min="0" aura:id="mbblInputs" label="Number of Months in Financial Statements" variant="label-hidden" value="{!v.mbblInputData.debtCapacityInitialDTO.tenure}" type="number" required="true" />
                                        </lightning:layoutItem>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:combobox
                                                name="ttccategory"
                                                label="Select TTC DG Category"
                                                value="{!v.mbblInputData.debtCapacityInitialDTO.currenctDGBucket}"
                                                placeholder="Select TTC DG Category"
                                                options="{!v.ttcOptions}"
                                                required="true">
                                            </lightning:combobox>
                                            <lightning:combobox
                                                name="mbblType"
                                                label="Select MBBL Type"
                                                placeholder="Select MBBL Type"
                                                value="{!v.mbblInputData.debtCapacityInitialDTO.mbblType}"
                                                options="{!v.mbblType}"
                                                required="true">
                                            </lightning:combobox>
                                            <lightning:combobox
                                                name="mbblType"
                                                label="Select Property Rating Type"
                                                placeholder="Select Property Rating Type"
                                                value="{!v.mbblInputData.propertyRatings}"
                                                options="{!v.propertyRatingType}"
                                                required="true">
                                            </lightning:combobox>
                                        </lightning:layoutItem>
                                    </lightning:layout>
                                    <h4 class="mbblModalHeaders">Income Statement</h4>
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Turnover / Sales" value="{!v.mbblInputData.incomeStatementDTO.saleAmount}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Depreciation / Amortisation" value="{!v.mbblInputData.incomeStatementDTO.depreciationAmortAmount}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Rent Expense" value="{!v.mbblInputData.incomeStatementDTO.rentExpense}" type="number" required="true" />
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Non-recurring income (-) / Non-recurring expenses (+) *If Applicable*" value="{!v.mbblInputData.incomeStatementDTO.nonRecurringEvents}" type="number" required="true" />
                                        </lightning:layoutItem>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <!-- <label class="slds-form-element__label"  style="margin-right: 0.5rem;">
                                                <abbr class="slds-required" title="required">*</abbr>Earnings before interest and tax (EBIT) (+ / -)</label>                                    
                                            <lightning:helptext content="EBIT Calculation. In this regard, extra-ordinary or non-recurring items (outside of the ordinary trade of the business) must be added to(+) and/or deducted from(-) the EBIT figure. For example: Loss(+)/profit(-) on disposal of assets; exchange rate gains(-)/losses(+); write down(+) of goodwill / intangibles; Upward(-)/Downward(+) revaluation amounts i.r.o assets; Restructuring profits(-)/losses(+); any non-cash items must be deducted." class="customIcon"/> -->
                                            <!-- <lightning:input step="0.01" aura:id="mbblInputs" label="Earnings before interest and tax (EBIT) (+ / -)" variant="label-hidden" value="{!v.mbblInputData.incomeStatementDTO.ebit}" type="number" required="true" /> -->
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Net Profit (+) / Loss (-)" value="{!v.mbblInputData.incomeStatementDTO.netProfit}" type="number" required="true" />
                                        </lightning:layoutItem>
                                    </lightning:layout>
                                    <h4 class="mbblModalHeaders">Cash Flow Statement</h4>
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Interest paid (+) / Interest received (-)" value="{!v.mbblInputData.cashflowStatementDTO.grossInterestPaid}" type="number" required="true" />
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Tax paid (+) / Tax received (-)" value="{!v.mbblInputData.cashflowStatementDTO.taxPaidReceived}" type="number" required="true" />
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Receivables" value="{!v.mbblInputData.cashflowStatementDTO.receivables}" type="number" required="true" />
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Payables" value="{!v.mbblInputData.cashflowStatementDTO.payables}" type="number" required="true" />
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Inventory" value="{!v.mbblInputData.cashflowStatementDTO.inventory}" type="number" required="true" />
                                        </lightning:layoutItem>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" aura:id="mbblInputs" label="Dividend paid (+) /Dividend received (-)" value="{!v.mbblInputData.cashflowStatementDTO.divdendPaidRecieved}" type="number" required="true" />
                                        </lightning:layoutItem>
                                    </lightning:layout>
                                    <h4 class="mbblModalHeaders">MBBL Balance Sheet</h4>
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Assets" value="{!v.mbblInputData.balanceSheetDTO.mbblBalanceSheetDTO.assets}" type="number" required="true" />
                                        </lightning:layoutItem>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Lower of Purchase Price Valuation" value="{!v.mbblInputData.balanceSheetDTO.mbblBalanceSheetDTO.lowerOfPurchasePriceValuation}" type="number" required="true" />
                                        </lightning:layoutItem>
                                    </lightning:layout>
                                    <h4 class="mbblModalHeaders">Balance Sheet</h4>
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Intangible Assets" value="{!v.mbblInputData.balanceSheetDTO.intangibleAssets}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Loans" value="{!v.mbblInputData.balanceSheetDTO.loans}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="CPF Bonds" value="{!v.mbblInputData.balanceSheetDTO.cpfOfBonds}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="CAF" value="{!v.mbblInputData.balanceSheetDTO.caf}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Inter-Co Loans" value="{!v.mbblInputData.balanceSheetDTO.interCoLoans}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Shareholder's Loans" value="{!v.mbblInputData.balanceSheetDTO.shareholdersLoans}" type="number" required="true" />
                                        </lightning:layoutItem>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Overdrafts" value="{!v.mbblInputData.balanceSheetDTO.overdrafts}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Equity" value="{!v.mbblInputData.balanceSheetDTO.equity}" type="number" required="true" />
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Other" value="{!v.mbblInputData.balanceSheetDTO.other}" type="number" required="true" />
                                            <lightning:input min="0" step="0.01" aura:id="mbblInputs" value="{!v.mbblInputData.balanceSheetDTO.cash}" type="number" required="true" label="Cash"/>
                                        </lightning:layoutItem>
                                    </lightning:layout>
                                    <h4 class="mbblModalHeaders">Minimum Annual Payments</h4>
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="0.01" min="0" aura:id="mbblInputs" label="Previous Year's Current Portion" value="{!v.mbblInputData.minimumAnnualPaymentsDTO.previousYearCurrentPortion}" type="number" required="true" />
                                        </lightning:layoutItem>
                                    </lightning:layout>
                                    <!-- <h4 class="mbblModalHeaders">Present Key Ratios</h4>
                                    <lightning:layout>
                                        <lightning:layoutItem size="6" padding="around-small">
                                            <lightning:input step="1" min="0" aura:id="mbblInputs" label="Terms In Months" value="{!v.mbblInputData.presentKeyRatiosDTO.termInmonths}" type="number" required="true" />
                                        </lightning:layoutItem>
                                    </lightning:layout> -->
                                    <lightning:button label="Save"
                                                      variant="brand" 
                                                      class="slds-button slds-m-top--medium slds-float_right"
                                                      onclick="{!c.saveFinData}"/>
                                    <div class="mbblModalMargin">
                                        
                                    </div>
                                    <aura:if isTrue="{!v.showModalSpinner}">
                                        <div class="slds-spinner_container">
                                            <lightning:spinner aura:id="spinner" variant="brand" size="medium" alternativeText="Loading...." />
                                        </div>
                                    </aura:if>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="slds-backdrop slds-backdrop--open" aura:id="backdrop">
            </div>
    </aura:if>
    <aura:if isTrue="{!v.mbblTableData}">

    </aura:if>
    <!-- Input Table View -->
    <aura:if isTrue="{!v.mbblTableData.length > 0}">
                <table class="tableBckColor slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">
                    <tr class="trHeight">
                        <div class="slds-text-heading_medium">
                            Debt Capacity Calculator MBBL Input
                        </div>                           
                    </tr>
                </table>
                <table class="slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">   
                    <tbody>
                        <aura:iteration items="{!v.mbblTableData}" var="item" indexVar="index">
                            <aura:if isTrue="{!item.header == 'Financial Statement Period Ending'}">
                                <tr class="row-head">
                                    <th scope="row">
                                        <div class="slds-truncate" title="{!item.header}" style="font-weight: bold;">{!item.header}</div>
                                    </th>
                                    <aura:iteration items="{!item.values}" var="dataValue">
                                        <td style="width: 10%; ; text-align: end">
                                            <div class="slds-truncate" title="{!dataValue}">{!dataValue}</div>
                                        </td>
                                    </aura:iteration>
                                </tr>
                            </aura:if>
                            <aura:if isTrue="{!item.isHeader == true}">
                                <tr class="row-head">
                                    <th scope="row" colspan="{!item.values.length + 1}">
                                        <div class="slds-truncate" title="Header" style="font-weight: bold;">{!item.header}</div>
                                    </th>
                                </tr>
                            </aura:if>
                            <aura:if isTrue="{!item.isHeader != true}">
                                <aura:if isTrue="{!item.header != 'Financial Statement Period Ending'}">
                                    <aura:if isTrue="{!item.header != 'Include In Calculation'}">
                                                <tr>
                                            <th scope="row">
                                                <div class="slds-truncate" title="{!item.header}">{!item.header}</div>
                                            </th>
                                            <aura:iteration items="{!item.values}" var="dataValue">
                                                <td style="width: 10%; text-align: end">
                                                    <aura:if isTrue="{!item.header == 'TTC DG Category'}">
                                                        <div class="slds-truncate" title="{!dataValue}">
                                                            {!dataValue}
                                                        </div>
                                                    </aura:if>
                                                    <aura:if isTrue="{!item.header == 'MBBL Type'}">
                                                        <div class="slds-truncate" title="{!dataValue}">
                                                            {!dataValue}
                                                        </div>
                                                    </aura:if>
                                                    <aura:if isTrue="{!item.header == 'Property Rating'}">
                                                        <div class="slds-truncate" title="{!dataValue}">
                                                            {!dataValue}
                                                        </div>
                                                    </aura:if>
                                                    <aura:if isTrue="{!item.header != 'TTC DG Category'}">
                                                        <aura:if isTrue="{!item.header != 'MBBL Type'}">
                                                            <aura:if isTrue="{!item.header != 'Property Rating'}">
                                                                <div class="slds-truncate" title="{!dataValue}">
                                                                    <lightning:formattedNumber value="{!dataValue}" maximumFractionDigits="2"/>
                                                                </div>
                                                            </aura:if>
                                                        </aura:if>
                                                    </aura:if>
                                                </td>
                                            </aura:iteration>
                                        </tr>
                                    </aura:if>
                                </aura:if>
                            </aura:if>
                            <aura:if isTrue="{!item.header == 'Include In Calculation'}">
                                <tr>
                                    <th scope="row">
                                        <div class="slds-truncate" title="{!item.header}">{!item.header}</div>
                                    </th>
                                    <aura:iteration items="{!item.values}" var="dataValue" indexVar="itemIndex">
                                        <td style="width: 10%;">
                                                <lightning:input type="checkbox" 
                                                                 aura:id="checkbox" 
                                                                 name="{!itemIndex}"
                                                                 checked="{!dataValue}"
                                                                 onchange="{!c.clickIncludeCheck}" />
                                        </td>
                                    </aura:iteration>
                                </tr>
                            </aura:if>
                            <aura:if isTrue="{!item.header == 'Include In Calculation'}">
                                <tr>
                                    <th scope="row" >
                                        <div class="slds-truncate" title="Operation"></div>
                                    </th>
                                    <aura:iteration items="{!item.values}" var="dataValue" indexVar="itemIndex">
                                        <td style="width: 10%;">
                                            <div align="center">
                                                <lightning:buttonIcon iconName="utility:edit"    
                                                                    name="{!itemIndex}"
                                                                    variant="container" 
                                                                    alternativeText="Edit"   
                                                                    class="slds-m-left_xx-small" 
                                                                    title="Edit"
                                                                    size="x-small"
                                                                    onclick="{!c.clickEdit}">
                                                </lightning:buttonIcon>
                                            <!--<lightning:buttonIcon iconName="utility:delete"
                                                                    name="{!itemIndex}"
                                                                    variant="container" 
                                                                    alternativeText="Delete"   
                                                                    class="slds-m-left_xx-small" 
                                                                    title="Delete"
                                                                    size="x-small"
                                                                    onclick="{!c.clickDelete}">
                                                </lightning:buttonIcon>-->
                                            </div>
                                        </td>
                                    </aura:iteration>
                        </tr>
                            </aura:if>
                            
                        </aura:iteration>
                    </tbody>
                </table>
                <aura:if isTrue="{!v.loanScenarioData.length > 0}">
                    <br/>
                    <br/>
                    <aura:if isTrue="{!v.allStoredMbblData.length > 0}">
                    <table class="tableBckColor slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">
                        <tr class="trHeight">
                            <div class="slds-text-heading_medium">
                                New Loan Scenarios
                            </div>                           
                        </tr>
                    </table>
                    <table class="slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">   
                        <thead>
                            <tr class="row-head">
                                    <th>
                                        <div class="slds-truncate" title="Loan Type" style="font-weight: bold;">Loan Type</div>
                                    </th>
                                    <th>
                                        <div class="slds-truncate" title="Amount" style="font-weight: bold;">Amount</div>
                                    </th>
                                    <th>
                                        <div class="slds-truncate" title="Term" style="font-weight: bold;">Term (Months)</div>
                                    </th>
                                    <th>
                                        <div class="slds-truncate" title="Interest Rate" style="font-weight: bold;">Interest Rate</div>
                                    </th>
                                    <th style="width: 10%;">
                                        
                                    </th>
                                </tr>
                        </thead>
                    <tbody>
                    <aura:iteration items="{!v.loanScenarioData}" var="item" indexVar="index">
                        <aura:if isTrue="{!item.type == 'Normal'}">
                            <tr>
                            <aura:if isTrue="{!item.loanType == '1'}">
                                <td>Term Loan</td>
                            </aura:if>
                            <aura:if isTrue="{!item.loanType == '2'}">
                                <td>CPF</td>
                            </aura:if>
                            <aura:if isTrue="{!item.loanType == '3'}">
                                <td>MBBL</td>
                            </aura:if>
                            <aura:if isTrue="{!item.loanType == '4'}">
                                <td>CAF</td>
                            </aura:if>
                            <td><div align="right"><lightning:formattedNumber value="{!item.loanAmount}" maximumFractionDigits="2"/></div></td>
                            <td><div align="right"><lightning:formattedNumber value="{!item.term}" maximumFractionDigits="2"/></div></td>
                            <td><div align="right"><lightning:formattedNumber value="{!item.uiPercentage}" maximumFractionDigits="2" style="percent"/></div></td>
                            <td>
                                <div align="center">
                                    <lightning:buttonIcon iconName="utility:edit"    
                                                        name="{!item.masterIndex}"
                                                        variant="container" 
                                                        alternativeText="Edit"   
                                                        class="slds-m-left_xx-small" 
                                                        title="Edit"
                                                        size="x-small"
                                                        onclick="{!c.clickEditNormalLoan}">
                                    </lightning:buttonIcon>
                                </div>
                            </td>
                        </tr>
                        </aura:if>
                        <aura:if isTrue="{!item.type == 'Overdraft'}">
                        <tr>
                            <td>Overdraft</td>
                            <td><div align="right"><lightning:formattedNumber value="{!item.loanAmount}" maximumFractionDigits="2"/></div></td>
                            <td><div align="right"><lightning:formattedNumber value="{!item.term}" maximumFractionDigits="2"/></div></td>
                            <td><div align="right"><lightning:formattedNumber value="{!item.uiPercentage}" maximumFractionDigits="2" style="percent"/></div></td>
                            <td>
                                <div align="center">
                                    <lightning:buttonIcon iconName="utility:edit"    
                                                        name="{!item.masterIndex}"
                                                        variant="container" 
                                                        alternativeText="Edit"   
                                                        class="slds-m-left_xx-small" 
                                                        title="Edit"
                                                        size="x-small"
                                                        onclick="{!c.clickEditOvrLoan}">
                                    </lightning:buttonIcon>
                                    <!-- <lightning:buttonIcon iconName="utility:delete"
                                                        name="{!item.masterIndex}"
                                                        variant="container" 
                                                        alternativeText="Delete"   
                                                        class="slds-m-left_xx-small" 
                                                        title="Delete"
                                                        size="x-small"
                                                        onclick="{!c.clickDeleteOvrLoan}">
                                    </lightning:buttonIcon> -->
                                </div>
                            </td>
                        </tr>
                        </aura:if>
                    </aura:iteration>
                    </tbody>
                    </table>
                    </aura:if>
                    <aura:set attribute="else">
                        <aura:if isTrue="{!v.mbblTableData.length > 0}">
                            <div style="padding-top: 20px">
                            	<p>
                                	<strong>No loan data is available</strong>
                            	</p>
                            </div>
                        </aura:if>
                    </aura:set>
                </aura:if>
                <br/>
                <br/>
    </aura:if>
    <div>
        <aura:if isTrue="{!lessthan(v.allStoredMbblData.length,3)}">
        	<lightning:button label="Add Financial Data"
                        title="Add Financial Data"
                        class="slds-button slds-m-top--medium "
                        onclick="{!c.openFinData}" />
        </aura:if>
        <aura:if isTrue="{!v.mbblTableData.length > 0}">
            <lightning:button label="Add Loan Data"
                        title="Add Loan Data"
                        class="slds-button slds-m-top--medium "
                        onclick="{!c.openLoanData}" />

            <aura:if isTrue="{!v.resultsAvailable == true}">
                <lightning:button 
                        label="Reset Calculator"
                        title="Reset Calculator"
                        class="slds-button slds-m-top--medium slds-float_right"
                        onclick="{!c.resetCalc}" />
                        <aura:set attribute="else">
                <lightning:button 
                        variant="brand"
                        label="Calculate"
                        title="Calculate"
                        class="slds-button slds-m-top--medium slds-float_right"
                        onclick="{!c.calculateMBBL}" />
                        </aura:set>
            </aura:if>
        </aura:if>
        
        <aura:if isTrue="{!v.mbblTableData.length == 0}">
            <p style="margin: 10px;"><strong>No Debt Capacity MBBL information available for this opportunity.</strong></p>
        </aura:if>
    </div>
    <aura:if isTrue="{!v.resultsAvailable == true}">
        <br/>
        <br/>
        <table class="tableBckColor slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">
                    <tr class="trHeight">
                        <div class="slds-text-heading_medium">
                            Debt Capacity Calculator MBBL Results
                        </div>                           
                    </tr>
                </table>
                <table class="slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">   
                    <tbody>
                        <aura:iteration items="{!v.mbblResultsTableData}" var="item" indexVar="index">
                            <aura:if isTrue="{!item.isHeader == true}">
                                <tr class="row-head">
                                    <th scope="row" colspan="{!item.values.length + 1}" style="border-top: 5px solid gray">
                                        <div class="slds-truncate" title="Header" style="font-weight: bold;">{!item.header}</div>
                                    </th>
                                </tr>
                            </aura:if>
                            <aura:if isTrue="{!item.isHeader != true}">
                                <aura:if isTrue="{!item.header != 'Financial Statement Period Ending'}">
                                    <tr>
                                    <th scope="row">
                                        <div class="slds-truncate" title="{!item.header}">{!item.header}</div>
                                    </th>
                                    <aura:iteration items="{!item.values}" var="dataValue">
                                        <aura:if isTrue="{!dataValue != ''}">
                                            <td style="width: 10%; text-align: end">
                                                <aura:if isTrue="{!or(item.header=='TTC DG Category',item.header=='MBBL Type')}">
                                                    <div class="slds-truncate" title="{!dataValue}">
                                                        {!dataValue}
                                                    </div>
                                                    <aura:set attribute="else">
                                                        <aura:if isTrue="{!item.header == 'Items'}">
                                                            <strong>{!dataValue}</strong>
                                                            <aura:set attribute="else">
                                                                <aura:if isTrue="{!item.header == 'LTV Specialised'}">
                                                                    <div class="slds-truncate" title="{!dataValue}">
                                                                        <lightning:formattedNumber value="{!dataValue}" minimumFractionDigits="2" maximumFractionDigits="2"/> %
                                                                    </div>
                                                                </aura:if>
                                                                <aura:if isTrue="{!or(item.header == 'Operating Profit Margin', item.header == 'LTV Non Specialised')}">
                                                                    <div class="slds-truncate" title="{!dataValue}">
                                                                        <lightning:formattedNumber value="{!dataValue}" minimumFractionDigits="2" maximumFractionDigits="2"/> %
                                                                    </div>
                                                                <aura:set attribute="else">
                                                                    <aura:if isTrue="{!item.header != 'LTV Specialised'}">
                                                                        <div class="slds-truncate" title="{!dataValue}">
                                                                            <lightning:formattedNumber value="{!dataValue}" minimumFractionDigits="2" maximumFractionDigits="2"/>
                                                                        </div>
                                                                    </aura:if>
                                                                </aura:set>
                                                                </aura:if>
                                                            </aura:set>
                                                        </aura:if>
                                                    </aura:set>
                                                </aura:if>
                                            </td>
                                        </aura:if>
                                        <aura:if isTrue="{!dataValue == ''}">
                                            <td style="border: none; width: 10%; background: #f2f2f2">
                                                <div class="slds-truncate" title=""></div>
                                            </td>
                                        </aura:if>
                                    </aura:iteration>
                                </tr>
                                </aura:if>
                            </aura:if>         
                        </aura:iteration>
                    </tbody>
                </table>
                <br/>
                <br/>
                <table class="slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">   
                    <tbody>
                        <aura:iteration items="{!v.mbblLoansResultsTableData}" var="item" indexVar="index">
                            <aura:if isTrue="{!item.isHeader != true}">
                                <aura:if isTrue="{!item.isDarkHeader == true}">
                                    <tr class="row-head">
                                    <th scope="row" colspan="{!item.values.length + 1}" style="background: lightgray">
                                        <div class="slds-truncate" title="Header" style="font-weight: bold;">{!item.header}</div>
                                    </th>
                                </tr>
                                </aura:if>
                            </aura:if>
                            <aura:if isTrue="{!item.isHeader == true}">
                                <tr class="row-head">
                                    <th scope="row" colspan="{!item.values.length + 1}" style="border-top: 5px solid gray; width: 10px">
                                        <div class="slds-truncate" title="Header" style="font-weight: bold">{!item.header}</div>
                                    </th>
                                </tr>
                            </aura:if>
                            <aura:if isTrue="{!item.isHeader != true}">
                                <aura:if isTrue="{!item.header != 'Financial Statement Period Ending'}">
                                    <aura:if isTrue="{!item.isDarkHeader == false}">
                                        <tr>
                                            <th scope="row">
                                                <div class="slds-truncate" title="{!item.header}">{!item.header}</div>
                                            </th>
                                            <aura:iteration items="{!item.values}" var="dataValue">
                                                <aura:if isTrue="{!and(dataValue != '', item.header == 'Type of Loan')}">
                                                    <td style="width: 10%; text-align: end">
                                                        <div class="slds-truncate" title="{!dataValue}">
                                                            {!dataValue}
                                                        </div>
                                                    </td>
                                                </aura:if>
                                                <aura:if isTrue="{!and(dataValue != '', item.header != 'Type of Loan')}">
                                                    <td style="width: 10%; text-align: end">
                                                        <div class="slds-truncate" title="{!dataValue}">
                                                            <lightning:formattedNumber value="{!dataValue}" minimumFractionDigits="2" maximumFractionDigits="2"/>
                                                        </div>
                                                    </td>
                                                </aura:if>
                                                <aura:if isTrue="{!dataValue == ''}">
                                                    <td style="border: none; width: 10%; background: #f2f2f2">
                                                        <div class="slds-truncate" title=""></div>
                                                    </td>
                                                </aura:if>
                                            </aura:iteration>
                                        </tr>
                                    </aura:if>
                                </aura:if>
                            </aura:if>         
                        </aura:iteration>
                    </tbody>
                </table>
                <br/>
                <br/>
                <table class="slds-table slds-table_cell-buffer slds-border_left slds-border_right slds-table_bordered slds-table_col-bordered">   
                    <tbody>
                        <aura:iteration items="{!v.mbblEKRResultsTableData}" var="item" indexVar="index">
                            <aura:if isTrue="{!item.isHeader == true}">
                                <tr class="row-head">
                                    <th scope="row" style="border-top: 5px solid gray">
                                        <div class="slds-truncate" title="Header" style="font-weight: bold;">{!item.header}</div>
                                    </th>
                                    <aura:iteration items="{!item.values}" var="dataValue">
                                        <td style="border-top: 5px solid gray; width: 10%; text-align: end">
                                                <div class="slds-truncate" title="{!dataValue}">
                                                    {!dataValue.value}
                                                </div>
                                        </td>
                                    </aura:iteration>
                                </tr>
                            </aura:if>
                            <aura:if isTrue="{!item.isHeader != true}">
                                    <tr>
                                        <th scope="row">
                                            <div class="slds-truncate" title="{!item.header}">{!item.header}</div>
                                        </th>
                                        <aura:iteration items="{!item.values}" var="dataValue">
                                            <aura:if isTrue="{!dataValue.value != ''}">
                                                <aura:if isTrue="{!dataValue.isNumber == true}">
                                                    <td style="width: 10%; text-align: end">
                                                        <aura:if isTrue="{!or(item.header == 'Max LTV Non Specialised', item.header == 'Max LTV Specialised')}">
                                                            <div class="slds-truncate" title="{!dataValue.value}">
                                                                <lightning:formattedNumber value="{!dataValue.value}" minimumFractionDigits="2" maximumFractionDigits="2"/> %
                                                            </div>
                                                        <aura:set attribute="else">
                                                            <div class="slds-truncate" title="{!dataValue.value}">
                                                                <lightning:formattedNumber value="{!dataValue.value}" minimumFractionDigits="2" maximumFractionDigits="2"/>
                                                            </div>
                                                        </aura:set>
                                                        </aura:if>
                                                    </td>
                                                    <aura:set attribute="else">
                                                        <td style="width: 10%; text-align: end">
                                                            <div class="slds-truncate" title="{!dataValue.value}">
                                                                {!dataValue.value}
                                                            </div>
                                                        </td>
                                                    </aura:set>
                                                </aura:if>
                                            </aura:if>
                                        </aura:iteration>
                                    </tr>
                            </aura:if>         
                        </aura:iteration>
                    </tbody>
                </table>
                <br/>
                <br/>
                <div>
                    <lightning:button 
                        variant="brand"
                        label="Export To PDF"
                        title="Export To PDF"
                        class="slds-button slds-m-top--medium slds-float_right"
                        onclick="{!c.exportToPdf}" />
                </div>
                <br/>
                <br/>
                <c:rejectCalculatorResults recordId = "{!v.recordId}"/>
    </aura:if>
    </div>
    </aura:if>
</aura:component>